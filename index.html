<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>COVID-19 India - Dashboard </title>
  <style>
    :root{--maxw:1100px;--bg:#f7f9fc;--card:#ffffff;--muted:#6b7280;--accent:#0f172a}
    body{font-family:Arial, Helvetica, sans-serif;background:var(--bg);color:var(--accent);margin:0;padding:24px;display:flex;justify-content:center}
    .container{width:100%;max-width:var(--maxw)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .search{display:flex;gap:8px}
    input[type=text]{padding:10px;border-radius:8px;border:1px solid #ddd;min-width:260px}
    button{padding:9px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    button.primary{background:#0369a1;color:#fff;border-color:#0369a1}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 2px rgba(16,24,40,0.04)}
    .wide{grid-column:span 3}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    th{font-weight:700;color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    .output{white-space:pre-wrap;font-family:monospace;font-size:13px}
    @media (max-width:980px){.grid{grid-template-columns:1fr} .wide{grid-column:span 1}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>COVID-19 India Dashboard</h1>
        
      
    </header>

    <div class="controls">
      <div class="search">
        <input id="stateInput" type="text" placeholder="Search state or UT (e.g. Gujarat)" />
        <button id="searchBtn" class="primary">Search</button>
      </div>
      <button id="showAllBtn">Show all states</button>
      <button id="refreshBtn">Refresh</button>
    </div>

    <div class="grid">
      <div class="card">
        <h3>National Summary</h3>
        <div id="national" class="muted">Loading...</div>
      </div>

      <div class="card">
        <h3>Testing (Latest)</h3>
        <div id="testing" class="muted">Loading...</div>
      </div>

      <div class="card">
        <h3>Contacts</h3>
        <div id="contacts" class="muted">Loading...</div>
      </div>

      <div class="card wide">
        <h3>State-wise Cases</h3>
        <div id="statesTable">Loading...</div>
      </div>

      <div class="card wide">
        <h3>State-wise Hospitals & Beds</h3>
        <div id="bedsTable">Loading...</div>
      </div>

      <div class="card wide">
        <h3>Output</h3>
        <div id="output" class="output">Ready</div>
      </div>
    </div>
  </div>

  <script>
  const api = {
    latest: 'https://api.rootnet.in/covid19-in/stats/latest',
    beds: 'https://api.rootnet.in/covid19-in/hospitals/beds',
    testingLatest: 'https://api.rootnet.in/covid19-in/stats/testing/latest',
    contacts: 'https://api.rootnet.in/covid19-in/contacts'
  };

  let dataCache = { latest: null, beds: null, testing: null, contacts: null };

  function setText(id, value){
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = String(value);
  }

  function normalizeNameSimple(s){
    return String(s || '').toLowerCase().replace(/[^a-z0-9]/g,'');
  }

  function levenshtein(a, b){
    const m = a.length, n = b.length;
    if (m === 0) return n;
    if (n === 0) return m;
    const dp = Array.from({length: m+1}, ()=> new Array(n+1).fill(0));
    for (let i=0;i<=m;i++) dp[i][0]=i;
    for (let j=0;j<=n;j++) dp[0][j]=j;
    for (let i=1;i<=m;i++){
      for (let j=1;j<=n;j++){
        const cost = a[i-1] === b[j-1] ? 0 : 1;
        dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
      }
    }
    return dp[m][n];
  }

  async function fetchJson(url){
    try{
      const r = await fetch(url);
      if (!r.ok) throw new Error('Network error');
      return await r.json();
    } catch(e){
      return { error: e.message };
    }
  }

  async function loadData(){
    setText('output','Refreshing data...');
    const [latestRes, bedsRes, testingRes, contactsRes] = await Promise.all([
      fetchJson(api.latest), fetchJson(api.beds), fetchJson(api.testingLatest), fetchJson(api.contacts)
    ]);

    if (!latestRes.error) dataCache.latest = latestRes.data || latestRes;
    if (!bedsRes.error) dataCache.beds = bedsRes.data || bedsRes;
    if (!testingRes.error) dataCache.testing = testingRes.data || testingRes;
    if (!contactsRes.error) dataCache.contacts = contactsRes.data || contactsRes;

    showNational();
    showTesting();
    showContacts();
    showStatesTable();
    showBedsTable();

    setText('output','Data loaded');
  }

  function showNational(){
    const d = dataCache.latest;
    if (!d || !d.summary){ setText('national','No data'); return }
    const s = d.summary;
    const updated = d.lastRefreshed || d.lastUpdated || '';
    const txt = 'Total: ' + (s.total ?? 'N/A') + '\n'
      + 'Confirmed (Indian): ' + (s.confirmedCasesIndian ?? 'N/A') + '\n'
      + 'Confirmed (Foreign): ' + (s.confirmedCasesForeign ?? 'N/A') + '\n'
      + 'Recovered: ' + (s.discharged ?? 'N/A') + '\n'
      + 'Deaths: ' + (s.deaths ?? 'N/A') + '\n'
      + 'Updated: ' + updated;
    setText('national', txt);
  }

  function showTesting(){
    const t = dataCache.testing;
    if (!t) { setText('testing','No data'); return }
    const s = t.summary || t;
    const txt = 'Samples tested: ' + (s.totalSamplesTested ?? 'N/A') + '\n'
      + 'Individuals tested: ' + (s.totalIndividualsTested ?? 'N/A') + '\n'
      + 'Positive cases: ' + (s.totalPositiveCases ?? 'N/A');
    setText('testing', txt);
  }

  function showContacts(){
    const c = dataCache.contacts;
    if (!c || !c.contacts || !c.contacts.primary){ setText('contacts','No data'); return }
    const p = c.contacts.primary;
    const txt = 'Number: ' + (p.number || 'N/A') + '\n'
      + 'Toll-free: ' + (p['number-tollfree'] || 'N/A') + '\n'
      + 'Email: ' + (p.email || 'N/A') + '\n'
      + 'Website: ' + (p.source || 'N/A');
    setText('contacts', txt);
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function showStatesTable(){
    const wrap = document.getElementById('statesTable');
    const d = dataCache.latest;
    if (!d || !d.regional){ wrap.textContent = 'No state data'; return }
    const rows = d.regional.map(r => ({ name: r.loc || r.region || 'Unknown', confirmed: r.totalConfirmed ?? r.confirmed ?? 'N/A' }));
    let html = '<table><thead><tr><th>State / UT</th><th>Confirmed</th></tr></thead><tbody>';
    rows.forEach(r => {
      html += '<tr><td>' + escapeHtml(r.name) + '</td><td>' + escapeHtml(r.confirmed) + '</td></tr>';
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
    window.stateList = rows.map(r => r.name);
  }

  function showBedsTable(){
    const wrap = document.getElementById('bedsTable');
    const b = dataCache.beds;
    if (!b || !b.regional){ wrap.textContent = 'No beds data'; return }
    let html = '<table><thead><tr><th>State / UT</th><th>Hospitals</th><th>Beds</th></tr></thead><tbody>';
    b.regional.forEach(r => {
      const name = r.state || r.loc || r.region || 'Unknown';
      const hosp = r.totalHospitals ?? r.hospitals ?? 'N/A';
      const beds = r.totalBeds ?? r.beds ?? 'N/A';
      html += '<tr><td>' + escapeHtml(name) + '</td><td>' + escapeHtml(hosp) + '</td><td>' + escapeHtml(beds) + '</td></tr>';
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
  }

  function findBedRowByName(name){
    const b = dataCache.beds && (dataCache.beds.regional || dataCache.beds);
    if (!b || !Array.isArray(b)) return null;
    const target = normalizeNameSimple(name);
    for (const r of b){
      const rn = normalizeNameSimple(r.state || r.loc || r.region || '');
      if (rn === target || rn.includes(target) || target.includes(rn)) return r;
      const dist = levenshtein(rn, target);
      if (dist <= 2) return r;
    }
    return null;
  }

  function searchStateByName(name){
    if (!name) { setText('output','Enter a state name'); return }
    const q = name.trim();
    const qn = normalizeNameSimple(q);
    const d = dataCache.latest;
    if (!d || !d.regional){ setText('output','State data not loaded'); return }
    const matches = [];
    for (const r of d.regional){
      const rn = normalizeNameSimple(r.loc || r.region || '');
      if (rn.includes(qn) || qn.includes(rn) || levenshtein(rn, qn) <= 2){
        matches.push(r);
      }
    }
    if (matches.length === 0){ setText('output','No state found for: ' + q); return }
    let out = '';
    for (const m of matches){
      const nm = m.loc || m.region || 'Unknown';
      out += 'State: ' + nm + '\n';
      out += 'Confirmed: ' + (m.totalConfirmed ?? m.confirmed ?? 'N/A') + '\n';
      out += 'Recovered: ' + (m.discharged ?? 'N/A') + '\n';
      out += 'Deaths: ' + (m.deaths ?? 'N/A') + '\n';
      const bedRow = findBedRowByName(nm);
      if (bedRow){
        out += 'Hospitals: ' + (bedRow.totalHospitals ?? bedRow.hospitals ?? 'N/A') + '\n';
        out += 'Beds: ' + (bedRow.totalBeds ?? bedRow.beds ?? 'N/A') + '\n';
      } else {
        out += 'Hospitals / beds: Not available\n';
      }
      out += '---\n';
    }
    setText('output', out);
  }

  document.getElementById('searchBtn').addEventListener('click', function(){ searchStateByName(document.getElementById('stateInput').value); });
  document.getElementById('showAllBtn').addEventListener('click', function(){
    const table = document.querySelector('#statesTable table');
    if (table) setText('output', table.outerHTML);
    else setText('output','States table not ready');
  });
  document.getElementById('refreshBtn').addEventListener('click', loadData);
  document.getElementById('stateInput').addEventListener('keyup', function(e){ if (e.key === 'Enter') searchStateByName(e.target.value); });

  loadData();
  </script>
</body>

</html>
